<!-- Profile Settings Page (Fall theme, tabs, WORKING buttons, local save + optional Supabase) -->
<div class="profile-page">
  <div class="profile-layout">

    <!-- LEFT SIDEBAR -->
    <aside class="settings-menu" aria-label="Settings menu">
      <h2 class="settings-title">Settings</h2>

      <div class="menu-section">
        <div class="menu-section-title">Account</div>

        <button class="menu-item active" type="button" data-tab="tab-profile" id="tabBtnProfile">
          Edit profile
          <span class="menu-arrow">‚Ä∫</span>
        </button>

        <button class="menu-item" type="button" data-tab="tab-password" id="tabBtnPassword">
          Change password
          <span class="menu-arrow">‚Ä∫</span>
        </button>
      </div>

      <div class="menu-section">
        <div class="menu-section-title">More</div>

        <button class="menu-item" type="button" data-tab="tab-preferences" id="tabBtnPrefs">
          Preferences
          <span class="menu-arrow">‚Ä∫</span>
        </button>
      </div>

      <div class="menu-footer">
        <button class="btn btn-outline" type="button" id="logoutBtn">Logout</button>
      </div>
    </aside>

    <!-- RIGHT CONTENT -->
    <main class="settings-content">

      <header class="profile-header">
        <div>
          <h1 class="profile-title">Profile Settings</h1>
          <p class="profile-subtitle">Manage your account settings.</p>
        </div>
      </header>

      <!-- Status messages -->
      <div class="panel" id="statusPanel" style="display:none;">
        <div class="panel-body">
          <p id="statusMsg" style="margin:0;"></p>
        </div>
      </div>

      <!-- ========================= -->
      <!-- TAB 1: PROFILE             -->
      <!-- ========================= -->
      <section class="panel tab-section" id="tab-profile">
        <div class="panel-header">
          <h2 class="panel-title">Profile</h2>
        </div>

        <div class="panel-body">

          <!-- SUMMARY CARD -->
          <div class="summary-card">
            <div class="summary-left">
              <div class="avatar" aria-hidden="true">üë§</div>
              <div>
                <div class="summary-name" id="viewName">‚Äî</div>
                <div class="summary-sub" id="viewSubscription">Subscription: ‚Äî</div>
              </div>
            </div>
          </div>

          <!-- CURRENT INFO (VIEW ONLY) -->
          <section class="panel inner-panel" aria-label="Current information">
            <div class="panel-header">
              <h3 class="panel-title">Current Information</h3>
            </div>

            <div class="panel-body">
              <div class="field-row">
                <div class="field-label">Name</div>
                <div class="field-value" id="viewName2">‚Äî</div>
              </div>

              <div class="field-row">
                <div class="field-label">Email</div>
                <div class="field-value" id="viewEmail">‚Äî</div>
              </div>

              <div class="field-row">
                <div class="field-label">Phone</div>
                <div class="field-value" id="viewPhone">‚Äî</div>
              </div>

              <div class="field-row">
                <div class="field-label">Password</div>
                <div class="field-value">********</div>
              </div>

              <div class="field-row">
                <div class="field-label">Enrolled</div>
                <div class="field-value" id="viewEnrolled">‚Äî</div>
              </div>
            </div>
          </section>

          <!-- EDIT BUTTON -->
          <div class="row-between" style="margin-top:12px;">
            <p class="muted" style="margin:0;">Need to update something? Click Edit.</p>
            <button class="btn btn-amber" type="button" id="editBtn">Edit</button>
          </div>

          <!-- EDIT FORM -->
          <form id="profileForm" class="form" style="display:none;" novalidate>
            <div class="form-row">
              <label class="field-label" for="nameInput">Name</label>
              <input class="input" id="nameInput" name="name" type="text" />
              <div class="error-text" id="nameError" style="display:none;">Name is required.</div>
            </div>

            <div class="form-row">
              <label class="field-label" for="phoneInput">Phone</label>
              <input class="input" id="phoneInput" name="phone" type="tel" />
              <div class="hint">Optional. Digits only (no dashes).</div>
              <div class="error-text" id="phoneError" style="display:none;">Enter a valid 10-digit phone number.</div>
            </div>

            <div class="form-row">
              <div class="row-between">
                <label class="field-label" for="emailInput">Email</label>
                <label class="mini-check">
                  <input type="checkbox" id="toggleEmailEdit" />
                  <span>Change email</span>
                </label>
              </div>

              <input class="input" id="emailInput" name="email" type="email" disabled />
              <div class="hint">Email only updates if ‚ÄúChange email‚Äù is enabled.</div>
              <div class="error-text" id="emailError" style="display:none;">Enter a valid email address.</div>
            </div>

            <div class="actions-row">
              <button class="btn btn-amber" type="submit" id="saveProfileBtn">Save</button>
              <button class="btn btn-outline" type="button" id="cancelProfileBtn">Cancel</button>
            </div>
          </form>

        </div>
      </section>

      <!-- ========================= -->
      <!-- TAB 2: PASSWORD            -->
      <!-- ========================= -->
      <section class="panel tab-section" id="tab-password" style="display:none;">
        <div class="panel-header">
          <h2 class="panel-title">Change Password</h2>
        </div>

        <div class="panel-body">
          <p class="muted">Update your password here.</p>

          <form id="passwordForm" class="form" novalidate>
            <div class="form-row">
              <label class="field-label" for="newPasswordInput">New Password</label>
              <input class="input" id="newPasswordInput" type="password" placeholder="New password" />
            </div>

            <div class="actions-row">
              <button class="btn btn-amber" type="submit">Update Password</button>
            </div>
          </form>
        </div>
      </section>

      <!-- ========================= -->
      <!-- TAB 3: PREFERENCES         -->
      <!-- ========================= -->
      <section class="panel tab-section" id="tab-preferences" style="display:none;">
        <div class="panel-header">
          <h2 class="panel-title">Preferences</h2>
        </div>

        <div class="panel-body">
          <p class="muted">Customize your experience.</p>

          <form id="prefsForm" class="form" novalidate>
            <label class="check-row">
              <input type="checkbox" id="prefEmailUpdates" />
              <span>Receive email updates</span>
            </label>

            <div class="actions-row">
              <button class="btn btn-amber" type="submit">Save Preferences</button>
            </div>
          </form>
        </div>
      </section>

    </main>
  </div>
</div>

<!-- FALL THEME STYLES -->
<style>
  :root{
    --paper:#f3e8d7; --paper-2:#fff8ee; --ink:#2a1f18; --muted:#6a5a4f;
    --border:rgba(60,35,20,0.20); --shadow:0 10px 30px rgba(0,0,0,0.10);
    --brown:#6b4a2f; --brown-dark:#4a321f; --amber:#d77c2f; --amber-dark:#b7631d;
  }
  .profile-page{
    min-height: calc(100vh - 80px);
    padding: 22px 16px;
    background:
      radial-gradient(circle at 20% 10%, rgba(215,124,47,0.12), transparent 55%),
      radial-gradient(circle at 80% 20%, rgba(161,75,42,0.10), transparent 60%),
      linear-gradient(180deg, var(--paper), var(--paper-2));
    color: var(--ink);
  }
  .profile-layout{ max-width: 1100px; margin: 0 auto; display:flex; gap:18px; align-items:flex-start; }
  .settings-menu{
    width:280px; background: rgba(255,255,255,0.62); border:1px solid var(--border);
    border-radius:14px; padding:14px; box-shadow: var(--shadow);
  }
  .settings-title{ margin: 4px 0 10px 0; font-size: 20px; color: var(--brown-dark); }
  .menu-section{ margin-bottom: 14px; }
  .menu-section-title{ font-size: 12px; text-transform: uppercase; letter-spacing: 0.6px; opacity: 0.75; margin: 10px 0; }
  .menu-item{
    width:100%; display:flex; justify-content:space-between; align-items:center; padding: 10px 10px;
    border-radius: 12px; border: 1px solid rgba(60,35,20,0.16); background: rgba(255,255,255,0.65);
    cursor:pointer; margin-bottom: 8px; font-weight: 700; color: var(--brown-dark);
  }
  .menu-item.active{ border-color: rgba(215,124,47,0.55); box-shadow: 0 0 0 3px rgba(215,124,47,0.12); }
  .menu-arrow{ opacity: 0.7; }
  .menu-footer{ margin-top: 18px; display:flex; justify-content:center; }
  .settings-content{ flex:1; min-width:0; }
  .profile-header{ display:flex; justify-content:space-between; align-items:flex-end; margin-bottom: 14px; }
  .profile-title{ margin:0; font-size: 34px; color: var(--brown-dark); }
  .profile-subtitle{ margin:6px 0 0 0; color: var(--muted); }
  .panel{
    background: rgba(255,255,255,0.62); border:1px solid var(--border); border-radius:14px;
    box-shadow: var(--shadow); margin-bottom: 14px; overflow:hidden;
  }
  .inner-panel{ box-shadow: none; background: rgba(255,255,255,0.55); border-style: dashed; }
  .panel-header{
    padding: 12px 14px; border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(215,124,47,0.08), rgba(255,255,255,0.35));
  }
  .panel-title{ margin:0; color: var(--brown-dark); }
  .panel-body{ padding: 14px; }
  .muted{ color: var(--muted); }
  .summary-card{
    display:flex; justify-content:space-between; align-items:center; padding: 12px;
    border-radius: 14px; border: 1px dashed rgba(161,75,42,0.35);
    background: rgba(255,255,255,0.55); margin-bottom: 12px;
  }
  .summary-left{ display:flex; gap:12px; align-items:center; }
  .avatar{
    width:44px; height:44px; border-radius: 50%;
    display:flex; align-items:center; justify-content:center;
    background: rgba(215,124,47,0.15); border: 1px solid rgba(215,124,47,0.25); font-size: 20px;
  }
  .summary-name{ font-weight: 800; }
  .summary-sub{ font-size: 13px; color: var(--muted); margin-top: 2px; }
  .row-between{ display:flex; justify-content:space-between; align-items:center; gap: 10px; margin-bottom: 10px; }
  .field-row{
    display:flex; justify-content:space-between; gap: 14px; padding: 10px 0;
    border-bottom: 1px solid rgba(60,35,20,0.10);
  }
  .field-row:last-child{ border-bottom:none; }
  .field-label{ font-weight: 800; color: var(--brown-dark); }
  .field-value{ color: var(--ink); text-align:right; }
  .form-row{ margin-bottom: 14px; }
  .field-label{ display:block; font-weight: 800; color: var(--brown-dark); margin-bottom: 6px; }
  .input{
    width:100%; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border);
    background: rgba(255,255,255,0.75); outline:none;
  }
  .input:disabled{ opacity: 0.75; cursor: not-allowed; }
  .hint{ font-size: 12px; color: var(--muted); margin-top: 6px; }
  .mini-check{ display:flex; gap:8px; align-items:center; font-size: 12px; color: var(--muted); user-select:none; }
  .actions-row{ display:flex; justify-content:flex-end; gap:10px; margin-top: 6px; }
  .btn{ border-radius: 12px; padding: 9px 14px; font-weight: 800; cursor:pointer;
    border: 1px solid rgba(60,35,20,0.18); background: rgba(255,255,255,0.65);
  }
  .btn-amber{ border: none; background: var(--amber); color:#fff; }
  .btn-amber:hover{ background: var(--amber-dark); }
  .btn-outline{ background: rgba(255,255,255,0.65); color: var(--brown-dark); }
  .error-text{ margin-top:6px; font-size: 12px; color: #9c2f27; }
  .check-row{
    display:flex; gap:10px; align-items:center; padding: 12px; border-radius: 14px;
    border: 1px solid rgba(60,35,20,0.14); background: rgba(255,255,255,0.55);
    margin-bottom: 10px; font-weight: 700; color: var(--brown-dark);
  }
  @media (max-width: 860px){
    .profile-layout{ flex-direction: column; }
    .settings-menu{ width: 100%; }
    .profile-title{ font-size: 28px; }
    .field-value{ text-align:left; }
    .field-row{ flex-direction: column; }
  }
</style>

<!-- ‚úÖ NON-MODULE SCRIPT so buttons ALWAYS work -->
<script>
  (function () {
    const $ = (id) => document.getElementById(id);

    // Default (your info)
    const DEFAULT_PROFILE = {
      name: "Mandee Jauregui",
      email: "mandeejauregui@icloud.com",
      phone: "7073301137",
      subscription: "Free",
      emailUpdates: true
    };

    // Load from localStorage (persist after refresh)
    const saved = localStorage.getItem("IF_PROFILE");
    const PROFILE = saved ? { ...DEFAULT_PROFILE, ...JSON.parse(saved) } : { ...DEFAULT_PROFILE };

    // Enrolled date = TODAY (always)
    const enrolledToday = new Date().toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
    $("viewEnrolled").textContent = enrolledToday;

    function renderView() {
      $("viewName").textContent = PROFILE.name || "‚Äî";
      $("viewName2").textContent = PROFILE.name || "‚Äî";
      $("viewEmail").textContent = PROFILE.email || "‚Äî";
      $("viewPhone").textContent = PROFILE.phone || "‚Äî";
      $("viewSubscription").textContent = `Subscription: ${PROFILE.subscription || "Free"}`;

      $("nameInput").value = PROFILE.name || "";
      $("phoneInput").value = PROFILE.phone || "";
      $("emailInput").value = PROFILE.email || "";

      $("prefEmailUpdates").checked = PROFILE.emailUpdates === true;
    }

    function saveLocal() {
      localStorage.setItem("IF_PROFILE", JSON.stringify(PROFILE));
    }

    // Tabs
    const tabs = Array.from(document.querySelectorAll(".tab-section"));
    const menuButtons = Array.from(document.querySelectorAll(".menu-item"));

    function showTab(tabId) {
      tabs.forEach(t => t.style.display = (t.id === tabId) ? "block" : "none");
      menuButtons.forEach(b => b.classList.toggle("active", b.getAttribute("data-tab") === tabId));
    }

    menuButtons.forEach(btn => btn.addEventListener("click", () => showTab(btn.getAttribute("data-tab"))));
    showTab("tab-profile");

    // Edit show/hide
    $("editBtn").addEventListener("click", () => {
      $("profileForm").style.display = "block";
    });

    $("cancelProfileBtn").addEventListener("click", () => {
      $("profileForm").style.display = "none";
      $("toggleEmailEdit").checked = false;
      $("emailInput").disabled = true;
      renderView();
    });

    // Email toggle
    $("toggleEmailEdit").addEventListener("change", () => {
      $("emailInput").disabled = !$("toggleEmailEdit").checked;
      $("emailError").style.display = "none";
    });

    // Validation helpers
    function validEmail(v) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    }
    function digitsOnlyPhone(v) {
      return (v || "").replace(/\D/g, "");
    }

    // Save profile (LOCAL always works)
    $("profileForm").addEventListener("submit", (e) => {
      e.preventDefault();

      const newName = ($("nameInput").value || "").trim();
      const phoneDigits = digitsOnlyPhone($("phoneInput").value);
      const wantsEmailChange = !$("emailInput").disabled;
      const newEmail = ($("emailInput").value || "").trim();

      // validate
      $("nameError").style.display = newName ? "none" : "block";

      const phoneOk = !phoneDigits || phoneDigits.length === 10;
      $("phoneError").style.display = phoneOk ? "none" : "block";

      const emailOk = !wantsEmailChange || validEmail(newEmail);
      $("emailError").style.display = emailOk ? "none" : "block";

      if (!newName || !phoneOk || !emailOk) return;

      PROFILE.name = newName;
      PROFILE.phone = phoneDigits || "";
      if (wantsEmailChange) PROFILE.email = newEmail;

      saveLocal();
      renderView();

      $("profileForm").style.display = "none";
      $("toggleEmailEdit").checked = false;
      $("emailInput").disabled = true;

      // Tell module script (if it loaded) to sync with Supabase
      window.__IF_PROFILE_SYNC__ && window.__IF_PROFILE_SYNC__({ ...PROFILE, wantsEmailChange });
    });

    // Preferences
    $("prefsForm").addEventListener("submit", (e) => {
      e.preventDefault();
      PROFILE.emailUpdates = $("prefEmailUpdates").checked === true;
      saveLocal();
      renderView();

      window.__IF_PREFS_SYNC__ && window.__IF_PREFS_SYNC__({ emailUpdates: PROFILE.emailUpdates });
    });

    // Password (UI only here; Supabase sync handled in module if available)
    $("passwordForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const pw = ($("newPasswordInput").value || "").trim();
      if (!pw) return;
      $("newPasswordInput").value = "";
      window.__IF_PASSWORD_SYNC__ && window.__IF_PASSWORD_SYNC__({ password: pw });
    });

    // Logout (if Supabase loaded, module will handle too)
    $("logoutBtn").addEventListener("click", () => {
      window.__IF_LOGOUT__ && window.__IF_LOGOUT__();
      // still navigate for now
      window.location.href = "./login.html";
    });

    renderView();
  })();
</script>

<!-- ‚úÖ MODULE SCRIPT: tries Supabase but NEVER breaks UI if path is wrong -->
<script type="module">
  let supabase = null;

  try {
    const mod = await import("../js/modules/supabase.js");
    supabase = mod.supabase;
  } catch (e) {
    // If this fails, the UI STILL works via the non-module script.
    console.log("Supabase import failed (buttons still work):", e?.message || e);
  }

  if (!supabase) {
    // No Supabase ‚Äî just exit.
    window.__IF_PROFILE_SYNC__ = null;
    window.__IF_PREFS_SYNC__ = null;
    window.__IF_PASSWORD_SYNC__ = null;
    window.__IF_LOGOUT__ = null;
  } else {
    // Save profile to Supabase if logged in
    window.__IF_PROFILE_SYNC__ = async (payload) => {
      try {
        const { data } = await supabase.auth.getUser();
        const user = data?.user;
        if (!user) return;

        const updatePayload = {
          data: {
            full_name: payload.name,
            phone: payload.phone || null
          }
        };

        if (payload.wantsEmailChange && payload.email && payload.email !== user.email) {
          updatePayload.email = payload.email;
        }

        const { error } = await supabase.auth.updateUser(updatePayload);
        if (error) throw error;
      } catch (e) {
        console.log("Supabase profile save failed:", e?.message || e);
      }
    };

    window.__IF_PREFS_SYNC__ = async (payload) => {
      try {
        const { data } = await supabase.auth.getUser();
        if (!data?.user) return;

        const { error } = await supabase.auth.updateUser({
          data: { email_updates: payload.emailUpdates === true }
        });
        if (error) throw error;
      } catch (e) {
        console.log("Supabase prefs save failed:", e?.message || e);
      }
    };

    window.__IF_PASSWORD_SYNC__ = async (payload) => {
      try {
        const { data } = await supabase.auth.getUser();
        if (!data?.user) return;

        const { error } = await supabase.auth.updateUser({ password: payload.password });
        if (error) throw error;
      } catch (e) {
        console.log("Supabase password update failed:", e?.message || e);
      }
    };

    window.__IF_LOGOUT__ = async () => {
      try { await supabase.auth.signOut(); } catch (e) {}
    };
  }
</script>